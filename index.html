<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <style type="text/css">
            iframe#content {
                margin-top: 20px;
                margin-left: 5%;
                width: 90%;
                height: 600px;
            }
        </style>
    </head>
    <body>
        <div class="container">

            <hr />

            <div class="row" id="info-form">
                <div class="col-md-offset-2 col-md-4 form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Receipt Org</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="receipt_org" value="清华大学教育基金会">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Receipt Detail</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="receipt_detail" value="办公用品">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Order ID</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="id" value="140121VVJN5C">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Date</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="date" value="2014-01-21">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Time</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="time" value="18:22">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Type</label>
                        <div class="col-sm-8">
                            <select class="form-control" name="type">
                                <option value="/yihaodian.html" selected>一号店</option>
                                <option value="/jd.html">京东</option>
                                <option value="/amazon.html">亚马逊</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Name</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="name" value="张三">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Phone</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="phone" value="18812345678">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 control-label">Address</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control col-sm-10" name="address0" value="北京 北京市 海淀区">
                            <input type="text" class="form-control col-sm-10" name="address1" value="清华大学紫荆公寓2号楼2单元505A">
                            <input type="text" class="form-control col-sm-10" name="address2" value="100084">
                        </div>
                    </div>
                </div>
            </div>

            <hr />

            <div id="item-form-list">
            </div>

            <script type="text/x-data" id="item-form-html">
                <div class="form-horizontal row item-form">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">ID</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="id" value="0133135054">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="name" value="百宝源 新鲜水果  双流 红颜草莓  2盒 产地直销当天采摘">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Price</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="price" value="58">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Count</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="count" value="1">
                            </div>
                        </div>
                    </div>
                </div>
            </script>

            <hr />

            <div class="center-block" style="width: 200px;">
                <button id="add" class="btn btn-default">Add</button>
                <button id="del" class="btn btn-default">Del</button>
                <button id="submit" class="btn btn-primary">Submit</button>
            </div>

            <hr />
            
        </div>

        <iframe id="content" frameBorder="0"></iframe>
        <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
        <script type="text/javascript" src="js/handlebars-v3.0.0.js"></script>
        <script type="text/javascript">
            $("#submit").click(function(e){
                var source = $("select[name='type']").val();
                $.get(source, function(data){
                    var template = Handlebars.compile(data);
                    var params = {};
                    $('#info-form input').each(function(i, v){
                        var $v = $(v);
                        params[$v.attr("name")] = $v.val();
                    });
                    params["address"] = params["address0"] + " " + params["address1"] + " " + params["address2"];
                    params["total_price"] = 0.0;
                    var items = [];
                    $('#item-form-list .item-form').each(function(i, v){
                        var $v = $(v);
                        var item = {};
                        $("input", $v).each(function(j, x){
                            var $x = $(x);
                            item[$x.attr("name")] = $x.val();
                        });
                        item["total_price"] = parseFloat(item["price"]) * parseInt(item["count"]);
                        params["total_price"] += item["total_price"];

                        item["price"] = parseFloat(item["price"]).toFixed(2);
                        item["total_price"] = item["total_price"].toFixed(2);
                        item["customer_name"] = params["name"];
                        item["address0"] = params["address0"];
                        item["address1"] = params["address1"];
                        item["address2"] = params["address2"];
                        item["date"] = params["date"];
                        items.push(item);
                    });
                    params["items"] = items;
                    params["total_price"] = params["total_price"].toFixed(2);
                    console.log(params);
                    var html = template(params);
                    $("#content").contents().find('html').html(html);
                });
            });
            var add_item = function(e){
                var html = $('#item-form-html').html();
                $('#item-form-list').append(html);
            };
            $('#add').click(add_item);
            $('#del').click(function(e){
                $('#item-form-list').children().last().remove();
            });

            add_item();
        </script>
    </body>
</html>
